---
layout: post
title: 关于地图优化的一点故事
date: 2013-01-26 19:51:09
comments: true
tags:
---

最近的工作中有一大部分与地图加载的优化有关，做到目前，除了一些小问题，差不多算是收尾了。

本来不想再在博客里多提技术的东西，细枝末节没有讲头，不过想想里头不少故事，也受到不少同事的启发和帮助，就这么放过可惜了，还是拿来说道说道吧。

问题的开头，是我们的商户页前端性能很烂。有历史原因，也有客观因素，不细谈。造成页面慢的原因之一就是地图的加载无法并行化。我们最早用的是google map，之后由于他们的服务不太稳定，又同时与mapbar合作，根据当前城市的不同切换到不同的地图服务上。

两家提供的地图服务脚本在初始化的时候，都使用了document.write。这就导致我们无法动态创建script标签来对其进行[非阻塞的加载](http://www.nczonline.net/blog/2009/06/23/loading-javascript-without-blocking/)（自己简单实验了一下，动态标签里若包含document.write，会被无视掉，这也合情合理，因为浏览器无法判断这个时候要往文档的哪里写东西）。

那么我们只好把他们的脚本直接丢在页面上，顺序加载。但是这么做就会影响到dom ready的时间。所谓dom ready，指的就是浏览器认为文档树可以被操作的时刻，当页面上同步的js未载完的时候，文档随时有被其修改的可能，所以一定要到他们都加载完毕之后，才会触发dom ready。

这样一来，其他依赖这个时刻来初始化的业务逻辑，就不得不等地图加载完才能执行，一旦地图服务不稳定甚至超时，就会造成比较恶心的后果了。我们的商户页是访问量最大的一个页面，大部分都包含地图模块，所以这里消耗是无法接受的。

最初的方案，是选择一个第三方的地图代码放到我们自己这里来管理，这里选择google mapv3，因为其api更人性以及支持了，且对异步加载有了[不错的支持](https://developers.google.com/maps/documentation/javascript/basics?hl=zh-cn#Async)。问了站长，google map的代码不是开源协议的，这么做会不会有法律问题？站长表示都可以谈，一来我们不以次盈利，二来我们仍然是他们的付费用户，不会有问题。

代码拿过来以后，数据仍然是个问题。我们自己无法也不会去做地图图片数据的维护，量大成本高也不是我们的路数。那么当google的地图瓦块无法访问到的时候，就需要一个机制来切换到其他服务商的数据源上。

现在想来这个主意真是疯狂得有点不可理喻。虽然找到拼接图片地址的方法很容易。但是两家地图服务商的瓦块并不是一一对应的。这就需要反压缩两家的脚本，再从混淆过的代码中，试图找到各自的视窗、经纬度以及xyz坐标间的转换关系，并且以一个很可能非线性的函数来对其进行适配。google map v2加载模块，还是通过eval压缩后的代码完成的，这又给反解增加了一定难度。完全像是在黑暗中走迷宫，尝试了两天，放弃了。

第二天早上和组里的同学讨论了一下，有了现在的方案。即是把地图部分单纯的放到一个iframe中，并给父窗口暴露一些接口来对其进行操作。既然地图会卡当前文档dom，那何不把它放到另一个窗口中去呢，有点金蝉脱壳的味道。一拍大腿觉得靠谱可行，立马动工。

思路如前所述，从原来的页面上把地图脚本拿掉，做一个Map构造器，接受与原来版本类似的参数，同时再接受一个回调。这个构造器会在容纳地图的元素中创建一个iframe，加载实际生成地图的中间页面。当iframe的onload事件触发后，调用其中的init方法，真正的初始化地图，得到实例，再通过刚才注册的回调，把他传递出来。具体的实现可以看这个[gist](https://gist.github.com/4642313)。

到了这里基础设施就完成了，没碰到特别痛的地方。开始尝试应用到业务代码中。踩到一个历史留下的坑。因为mapbar只有一个实例，所以以前遥叔在做诸如查看大图以及查看附近停车位这样的功能不得不把地图节点拿掉，放到弹出层中，对其进行resize，按需求添加各种overlay，完了在浮层关闭的时候再把他们一个个去除，再把节点放回去，真是劳命伤财。

而当这个节点变成iframe之后，把他从文档中移除再放回去会造成其重新加载。重新加载的iframe中的内容虽然与原来的完全一样，但他已不再是那时的他了，新的iframe里的init没有人去触发，自然就是一片空白。[这篇文章](http://poeticcode.wordpress.com/2010/06/08/iframe-reloads-when-moved-around-the-dom-tree/)以及mozilla上的[这个bug](https://bugzilla.mozilla.org/show_bug.cgi?id=254144)都对此问题有阐述和讨论，大致就是在争论这是否是正确的行为，以及实现上为什么不好做要不要处理等等。

不过这样也好，既然你们已是完全不同的个体，那就区分对待，原来劳命伤财的事，现在都可以拿掉了。唯一美中不足的就是地图需要在新的iframe中重新加载，但作为一个并非频繁调用的功能，这是可以接受也符合逻辑的。

至此，基本完工。后面还需要做的事情包括iframe需要接受参数，获知父页面的城市，来切换不同的服务商；在nginx做一下反向代理，来支持不同的域名（网上流传的iframe跨域之入欲擒故纵一类的奇技淫巧终归不是正道）；以及google map在iframe中时有点诡异的渲染问题需要解决。但应该都不是什么大问题了吧。

2013-02-19
补充：ie下动态创建的iframe所添加的onload会无法触发，需要使用attachEvent来做兼容，也可以使用类库包装的方法来绑定事件。[refer](http://www.xiaoxiaozi.com/2010/01/05/1683/)

2013-03-23
补充：ie6先添加src后插入dom的iframe节点会存在无法加载的情况，需要在插入dom后手动再设置一次src。


